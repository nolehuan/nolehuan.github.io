{"title":"so","uid":"dbb86e8f6a01395cf52e4238dc8be85a","slug":"linux/so","date":"2023-11-26T19:30:29.000Z","updated":"2023-11-30T13:48:26.797Z","comments":true,"path":"api/articles/linux/so.json","cover":null,"content":"<h3 id=\"使用-mv-与-cp-命令更新运行中的动态链接库是否会发生问题？\"><a href=\"#使用-mv-与-cp-命令更新运行中的动态链接库是否会发生问题？\" class=\"headerlink\" title=\"使用 mv 与 cp 命令更新运行中的动态链接库是否会发生问题？\"></a>使用 mv 与 cp 命令更新运行中的动态链接库是否会发生问题？</h3><p><code>cp</code> 命令更新运行中的动态链接库会导致程序 <code>core</code> 掉？</p>\n<h4 id=\"Linux-文件系统\"><a href=\"#Linux-文件系统\" class=\"headerlink\" title=\"Linux 文件系统\"></a>Linux 文件系统</h4><p>Linux 文件系统中，每个文件对应一个 inode 与 dentry</p>\n<h5 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h5><p>硬盘分为两个区域：数据区与 inode table，inode 存储文件元信息，可以用 <code>stat</code> 命令查看</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">stat</span> test.cpp</span> </span><br><span class=\"line\">  File: test.cpp</span><br><span class=\"line\">  Size: 458       \tBlocks: 8          IO Block: 4096   regular file</span><br><span class=\"line\">Device: 10307h/66311d\tInode: 535078      Links: 1</span><br><span class=\"line\">Access: (0664/-rw-rw-r--)  Uid: ( 1000/nolehuan)   Gid: ( 1000/nolehuan)</span><br><span class=\"line\">Access: 2023-11-04 15:20:56.725957003 +0800</span><br><span class=\"line\">Modify: 2022-11-24 22:25:10.659748611 +0800</span><br><span class=\"line\">Change: 2022-11-24 22:25:10.659748611 +0800</span><br><span class=\"line\"> Birth: -</span><br></pre></td></tr></table></figure>\n<p><code>Links: 1</code> 记录硬链接计数，硬链接仅文件名不同，inode 号相同；软链接文件数据块中存放对应文件的路径</p>\n<p><code>ls -i</code> 命令查看文件 inode 编号<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">ls</span> -i test.cpp</span> </span><br><span class=\"line\">535078 test.cpp</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"dentry\"><a href=\"#dentry\" class=\"headerlink\" title=\"dentry\"></a>dentry</h5><p>directory entry 记录文件的目录信息与 inode 指针，存在于内存中</p>\n<p>程序运行时，进程 pcb 中保存一份文件描述符表，文件描述符对应进程已打开文件的 file 结构体，file 结构体中包括文件打开时的标志位、引用计数和 dentry 指针等信息，通过 dentry 指针找到文件对应 inode 进而操作文件</p>\n<h4 id=\"cp-mv-rm-原理\"><a href=\"#cp-mv-rm-原理\" class=\"headerlink\" title=\"cp mv rm 原理\"></a>cp mv rm 原理</h4><p>执行 <code>cp</code> 命令时 inode 号分配规则</p>\n<ul>\n<li>目标文件存在则 inode 保持文件覆盖前的编号</li>\n<li>目标文件不存在则分配一个未使用的 inode 号，并添加至 inode table</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">touch</span> a b &amp;&amp; <span class=\"built_in\">ls</span> -i a b</span></span><br><span class=\"line\">548015 a  560350 b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cp</span> a b &amp;&amp; <span class=\"built_in\">ls</span> -i a b</span></span><br><span class=\"line\">548015 a  560350 b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cp</span> b c &amp;&amp; <span class=\"built_in\">ls</span> -i b c</span></span><br><span class=\"line\">560350 b  584072 c</span><br></pre></td></tr></table></figure>\n<p>执行 <code>mv</code> 命令时，所在文件系统相同则保持源文件 inode 号<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">touch</span> a b &amp;&amp; <span class=\"built_in\">ls</span> -i a b</span></span><br><span class=\"line\">583955 a  584095 b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">mv</span> a b &amp;&amp; <span class=\"built_in\">ls</span> -i b</span></span><br><span class=\"line\">583955 b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">mv</span> b c &amp;&amp; <span class=\"built_in\">ls</span> -i c</span></span><br><span class=\"line\">583955 c</span><br></pre></td></tr></table></figure></p>\n<p><code>cp</code> 命令执行步骤</p>\n<ul>\n<li>inode 号分配</li>\n<li>新建 dentry 并指向 inode</li>\n<li>复制数据至 block 中</li>\n</ul>\n<p><code>rm</code> 命令执行步骤</p>\n<ul>\n<li>递减硬链接计数，计数归零时释放 inode 号</li>\n<li>将数据块挂至空闲链表</li>\n<li>删除目录映射表中的相关行</li>\n</ul>\n<p><code>mv</code> 命令执行步骤</p>\n<ul>\n<li>源文件与目标文件所在文件系统相同：新建 dentry，删除原 dentry，对 inode 无影响，不移动数据</li>\n<li>源文件与目标文件所在文件系统不同：<code>cp</code> + <code>rm</code></li>\n</ul>\n<p><code>strace</code> 命令跟踪 <code>cp</code> 执行过程<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cat</span> a</span></span><br><span class=\"line\">file a</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cat</span> b</span></span><br><span class=\"line\">file b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">strace <span class=\"built_in\">cp</span> a b</span></span><br><span class=\"line\">...</span><br><span class=\"line\">openat(AT_FDCWD, &quot;a&quot;, O_RDONLY)         = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;b&quot;, O_WRONLY|O_TRUNC) = 4</span><br><span class=\"line\">fstat(4, &#123;st_mode=S_IFREG|0664, st_size=0, ...&#125;) = 0</span><br><span class=\"line\">...</span><br><span class=\"line\">read(3, &quot;file a\\n&quot;, 131072)             = 7</span><br><span class=\"line\">write(4, &quot;file a\\n&quot;, 7)                 = 7</span><br><span class=\"line\">read(3, &quot;&quot;, 131072)                     = 0</span><br><span class=\"line\">close(4)                                = 0</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure></p>\n<details>\n<summary>details</summary>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">strace <span class=\"built_in\">cp</span> a b</span></span><br><span class=\"line\">execve(&quot;/bin/cp&quot;, [&quot;cp&quot;, &quot;a&quot;, &quot;b&quot;], 0x7ffccded9d50 /* 78 vars */) = 0</span><br><span class=\"line\">brk(NULL)                               = 0x55a404a95000</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/haswell/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/haswell/x86_64&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/haswell/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/haswell&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/x86_64&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/haswell/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/haswell/x86_64&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/haswell/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/haswell&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/x86_64&quot;, 0x7ffcc58a7250) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib&quot;, &#123;st_mode=S_IFDIR|0755, st_size=36864, ...&#125;) = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=223218, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 223218, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f89809af000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\20b\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=154832, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f89809ad000</span><br><span class=\"line\">mmap(NULL, 2259152, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f8980595000</span><br><span class=\"line\">mprotect(0x7f89805ba000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f89807b9000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x24000) = 0x7f89807b9000</span><br><span class=\"line\">mmap(0x7f89807bb000, 6352, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f89807bb000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libacl.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libacl.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\340\\33\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=31232, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2126336, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f898038d000</span><br><span class=\"line\">mprotect(0x7f8980394000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f8980593000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x6000) = 0x7f8980593000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libattr.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libattr.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\260\\20\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=18680, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2113752, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f8980188000</span><br><span class=\"line\">mprotect(0x7f898018c000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f898038b000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0x7f898038b000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\240\\35\\2\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2030928, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 4131552, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f897fd97000</span><br><span class=\"line\">mprotect(0x7f897ff7e000, 2097152, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f898017e000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f898017e000</span><br><span class=\"line\">mmap(0x7f8980184000, 15072, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f8980184000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libpcre.so.3&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libpcre.so.3&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0 \\25\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=460728, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2556168, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f897fb26000</span><br><span class=\"line\">mprotect(0x7f897fb96000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f897fd95000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x6f000) = 0x7f897fd95000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libdl.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libdl.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0P\\16\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=14560, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2109712, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f897f922000</span><br><span class=\"line\">mprotect(0x7f897f925000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f897fb24000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7f897fb24000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libpthread.so.0&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libpthread.so.0&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0000b\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=144976, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f89809ab000</span><br><span class=\"line\">mmap(NULL, 2221184, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f897f703000</span><br><span class=\"line\">mprotect(0x7f897f71d000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f897f91c000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19000) = 0x7f897f91c000</span><br><span class=\"line\">mmap(0x7f897f91e000, 13440, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f897f91e000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">mmap(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f89809a8000</span><br><span class=\"line\">arch_prctl(ARCH_SET_FS, 0x7f89809a8800) = 0</span><br><span class=\"line\">mprotect(0x7f898017e000, 16384, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f897f91c000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f897fb24000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f897fd95000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f898038b000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f8980593000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f89807b9000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x55a403631000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f89809e6000, 4096, PROT_READ) = 0</span><br><span class=\"line\">munmap(0x7f89809af000, 223218)          = 0</span><br><span class=\"line\">set_tid_address(0x7f89809a8ad0)         = 5123</span><br><span class=\"line\">set_robust_list(0x7f89809a8ae0, 24)     = 0</span><br><span class=\"line\">rt_sigaction(SIGRTMIN, &#123;sa_handler=0x7f897f708cb0, sa_mask=[], sa_flags=SA_RESTORER|SA_SIGINFO, sa_restorer=0x7f897f715980&#125;, NULL, 8) = 0</span><br><span class=\"line\">rt_sigaction(SIGRT_1, &#123;sa_handler=0x7f897f708d50, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART|SA_SIGINFO, sa_restorer=0x7f897f715980&#125;, NULL, 8) = 0</span><br><span class=\"line\">rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], NULL, 8) = 0</span><br><span class=\"line\">prlimit64(0, RLIMIT_STACK, NULL, &#123;rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY&#125;) = 0</span><br><span class=\"line\">statfs(&quot;/sys/fs/selinux&quot;, 0x7ffcc58a7b60) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">statfs(&quot;/selinux&quot;, 0x7ffcc58a7b60)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">brk(NULL)                               = 0x55a404a95000</span><br><span class=\"line\">brk(0x55a404ab6000)                     = 0x55a404ab6000</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/proc/filesystems&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class=\"line\">read(3, &quot;nodev\\tsysfs\\nnodev\\ttmpfs\\nnodev\\tbd&quot;..., 1024) = 393</span><br><span class=\"line\">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">access(&quot;/etc/selinux/config&quot;, F_OK)     = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=5513488, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 5513488, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f897f1c0000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">geteuid()                               = 1000</span><br><span class=\"line\">stat(&quot;b&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">stat(&quot;a&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">stat(&quot;b&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;a&quot;, O_RDONLY)         = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;b&quot;, O_WRONLY|O_TRUNC) = 4</span><br><span class=\"line\">fstat(4, &#123;st_mode=S_IFREG|0664, st_size=0, ...&#125;) = 0</span><br><span class=\"line\">fadvise64(3, 0, 0, POSIX_FADV_SEQUENTIAL) = 0</span><br><span class=\"line\">mmap(NULL, 139264, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f89809c4000</span><br><span class=\"line\">read(3, &quot;file a\\n&quot;, 131072)             = 7</span><br><span class=\"line\">write(4, &quot;file a\\n&quot;, 7)                 = 7</span><br><span class=\"line\">read(3, &quot;&quot;, 131072)                     = 0</span><br><span class=\"line\">close(4)                                = 0</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">munmap(0x7f89809c4000, 139264)          = 0</span><br><span class=\"line\">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class=\"line\">close(0)                                = 0</span><br><span class=\"line\">close(1)                                = 0</span><br><span class=\"line\">close(2)                                = 0</span><br><span class=\"line\">exit_group(0)                           = ?</span><br><span class=\"line\">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>\n</details>\n\n<p><code>strace</code> 命令跟踪 <code>mv</code> 执行过程<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cat</span> a</span></span><br><span class=\"line\">file a</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">cat</span> b</span></span><br><span class=\"line\">file b</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">strace <span class=\"built_in\">mv</span> a b</span></span><br><span class=\"line\">...</span><br><span class=\"line\">rename(&quot;a&quot;, &quot;b&quot;)                        = 0</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure></p>\n<details>\n<summary>details</summary>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">strace <span class=\"built_in\">mv</span> a b</span></span><br><span class=\"line\">execve(&quot;/bin/mv&quot;, [&quot;mv&quot;, &quot;a&quot;, &quot;b&quot;], 0x7fffb37729b0 /* 78 vars */) = 0</span><br><span class=\"line\">brk(NULL)                               = 0x55b38eebf000</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/haswell/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/haswell/x86_64&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/haswell/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/haswell&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls/x86_64&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/tls/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/tls&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/haswell/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/haswell/x86_64&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/haswell/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/haswell&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/x86_64/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib/x86_64&quot;, 0x7ffc2d702d20) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">stat(&quot;/opt/ros/melodic/lib&quot;, &#123;st_mode=S_IFDIR|0755, st_size=36864, ...&#125;) = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=223218, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 223218, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f615a44d000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\20b\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=154832, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f615a44b000</span><br><span class=\"line\">mmap(NULL, 2259152, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f615a033000</span><br><span class=\"line\">mprotect(0x7f615a058000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f615a257000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x24000) = 0x7f615a257000</span><br><span class=\"line\">mmap(0x7f615a259000, 6352, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f615a259000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libacl.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libacl.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\340\\33\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=31232, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2126336, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f6159e2b000</span><br><span class=\"line\">mprotect(0x7f6159e32000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f615a031000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x6000) = 0x7f615a031000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libattr.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libattr.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\260\\20\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=18680, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2113752, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f6159c26000</span><br><span class=\"line\">mprotect(0x7f6159c2a000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f6159e29000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0x7f6159e29000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0\\240\\35\\2\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2030928, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 4131552, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f6159835000</span><br><span class=\"line\">mprotect(0x7f6159a1c000, 2097152, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f6159c1c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f6159c1c000</span><br><span class=\"line\">mmap(0x7f6159c22000, 15072, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f6159c22000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libpcre.so.3&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libpcre.so.3&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0 \\25\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=460728, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2556168, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f61595c4000</span><br><span class=\"line\">mprotect(0x7f6159634000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f6159833000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x6f000) = 0x7f6159833000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libdl.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libdl.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0P\\16\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=14560, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 2109712, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f61593c0000</span><br><span class=\"line\">mprotect(0x7f61593c3000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f61595c2000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7f61595c2000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/opt/ros/melodic/lib/libpthread.so.0&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libpthread.so.0&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">read(3, &quot;\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0&gt;\\0\\1\\0\\0\\0000b\\0\\0\\0\\0\\0\\0&quot;..., 832) = 832</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=144976, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f615a449000</span><br><span class=\"line\">mmap(NULL, 2221184, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f61591a1000</span><br><span class=\"line\">mprotect(0x7f61591bb000, 2093056, PROT_NONE) = 0</span><br><span class=\"line\">mmap(0x7f61593ba000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19000) = 0x7f61593ba000</span><br><span class=\"line\">mmap(0x7f61593bc000, 13440, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f61593bc000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">mmap(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f615a446000</span><br><span class=\"line\">arch_prctl(ARCH_SET_FS, 0x7f615a446800) = 0</span><br><span class=\"line\">mprotect(0x7f6159c1c000, 16384, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f61593ba000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f61595c2000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f6159833000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f6159e29000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f615a031000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f615a257000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x55b38e8b8000, 4096, PROT_READ) = 0</span><br><span class=\"line\">mprotect(0x7f615a484000, 4096, PROT_READ) = 0</span><br><span class=\"line\">munmap(0x7f615a44d000, 223218)          = 0</span><br><span class=\"line\">set_tid_address(0x7f615a446ad0)         = 6068</span><br><span class=\"line\">set_robust_list(0x7f615a446ae0, 24)     = 0</span><br><span class=\"line\">rt_sigaction(SIGRTMIN, &#123;sa_handler=0x7f61591a6cb0, sa_mask=[], sa_flags=SA_RESTORER|SA_SIGINFO, sa_restorer=0x7f61591b3980&#125;, NULL, 8) = 0</span><br><span class=\"line\">rt_sigaction(SIGRT_1, &#123;sa_handler=0x7f61591a6d50, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART|SA_SIGINFO, sa_restorer=0x7f61591b3980&#125;, NULL, 8) = 0</span><br><span class=\"line\">rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], NULL, 8) = 0</span><br><span class=\"line\">prlimit64(0, RLIMIT_STACK, NULL, &#123;rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY&#125;) = 0</span><br><span class=\"line\">statfs(&quot;/sys/fs/selinux&quot;, 0x7ffc2d703630) = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">statfs(&quot;/selinux&quot;, 0x7ffc2d703630)      = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">brk(NULL)                               = 0x55b38eebf000</span><br><span class=\"line\">brk(0x55b38eee0000)                     = 0x55b38eee0000</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/proc/filesystems&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class=\"line\">read(3, &quot;nodev\\tsysfs\\nnodev\\ttmpfs\\nnodev\\tbd&quot;..., 1024) = 393</span><br><span class=\"line\">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">access(&quot;/etc/selinux/config&quot;, F_OK)     = -1 ENOENT (No such file or directory)</span><br><span class=\"line\">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class=\"line\">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=5513488, ...&#125;) = 0</span><br><span class=\"line\">mmap(NULL, 5513488, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f6158c5e000</span><br><span class=\"line\">close(3)                                = 0</span><br><span class=\"line\">geteuid()                               = 1000</span><br><span class=\"line\">ioctl(0, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class=\"line\">stat(&quot;b&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">lstat(&quot;a&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">lstat(&quot;b&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">geteuid()                               = 1000</span><br><span class=\"line\">stat(&quot;b&quot;, &#123;st_mode=S_IFREG|0664, st_size=7, ...&#125;) = 0</span><br><span class=\"line\">geteuid()                               = 1000</span><br><span class=\"line\">getegid()                               = 1000</span><br><span class=\"line\">getuid()                                = 1000</span><br><span class=\"line\">getgid()                                = 1000</span><br><span class=\"line\">access(&quot;b&quot;, W_OK)                       = 0</span><br><span class=\"line\">rename(&quot;a&quot;, &quot;b&quot;)                        = 0</span><br><span class=\"line\">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class=\"line\">close(0)                                = 0</span><br><span class=\"line\">close(1)                                = 0</span><br><span class=\"line\">close(2)                                = 0</span><br><span class=\"line\">exit_group(0)                           = ?</span><br><span class=\"line\">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>\n</details>\n\n<h4 id=\"动态库\"><a href=\"#动态库\" class=\"headerlink\" title=\"动态库\"></a>动态库</h4><p>应用程序使用动态库过程</p>\n<ul>\n<li>应用程序通过 <code>dlopen</code> 打开 so 时，内核通过 <code>mmap</code> 将 so 加载到进程地址空间，对应虚拟内存区域 VMA 中的页 page</li>\n<li>加载器 loader 将 so 里引用的外部符号解析成真正的虚拟地址</li>\n<li>当 so 被 <code>cp</code> trunc 时，内核将旧 so 文件从虚拟内存对应物理内存中清除</li>\n<li>当应用程序运行到 so 中的代码时，产生缺页中断</li>\n<li>内核重新加载新 so<ul>\n<li>如果文件偏移量超出新 so 地址范围，将产生 bus error</li>\n<li>如果新 so 依赖外部符号，此时全局符号表没有经过重新解析，将产生段错误</li>\n<li>如果新 so 不依赖外部符号，程序可以运行</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h4><p>库文件<br><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;new lib\\n&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;old lib\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"type\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> a = <span class=\"number\">1</span>, b = <span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> c = a + b;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>测试文件<br><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;dlfcn.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"type\">void</span>* handle;</span><br><span class=\"line\">  <span class=\"built_in\">void</span> (*func)(<span class=\"type\">void</span>);</span><br><span class=\"line\">  <span class=\"built_in\">void</span> (*add)(<span class=\"type\">void</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  handle = <span class=\"built_in\">dlopen</span>(<span class=\"string\">&quot;libtest.so&quot;</span>, RTLD_LAZY);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!handle) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(stderr, <span class=\"string\">&quot;%s\\n&quot;</span>, <span class=\"built_in\">dlerror</span>());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  func = <span class=\"built_in\">dlsym</span>(handle, <span class=\"string\">&quot;func&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">dlerror</span>() != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(stderr, <span class=\"string\">&quot;%s\\n&quot;</span>, <span class=\"built_in\">dlerror</span>());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">func</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  add = <span class=\"built_in\">dlsym</span>(handle, <span class=\"string\">&quot;add&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">dlerror</span>() != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(stderr, <span class=\"string\">&quot;%s\\n&quot;</span>, <span class=\"built_in\">dlerror</span>());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">add</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">dlclose</span>(handle);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>编译<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gcc -fPIC -shared -o libtest.so libtest.c -g</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gcc -o use_lib use_lib.c -ldl -g</span></span><br></pre></td></tr></table></figure></p>\n<p><code>-g</code> 生成调试信息</p>\n<p><code>-fPIC</code> 生成位置无关代码(Position-Independent Code)，创建共享库时允许代码在任何内存地址执行而无需修改</p>\n<p>报错解决，修改 LD_PRELOAD 无效<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libtest.so: cannot open shared object file: No such file or directory</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">export</span> LD_LIBRARY_PATH=$(<span class=\"built_in\">pwd</span>):<span class=\"variable\">$LD_LIBRARY_PATH</span></span></span><br></pre></td></tr></table></figure></p>\n<p>gdb 调试：函数调用处添加断点后，在另一终端 <code>cp</code> 替换库文件 so，回到 gdb <code>n</code> 继续单步运行</p>\n<ul>\n<li>func 函数断点调试</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gdb use_lib</span></span><br><span class=\"line\">GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1</span><br><span class=\"line\">...</span><br><span class=\"line\">Reading symbols from use_lib...done.</span><br><span class=\"line\">(gdb) b 20</span><br><span class=\"line\">Breakpoint 1 at 0x876: file use_lib.c, line 20.</span><br><span class=\"line\">(gdb) r</span><br><span class=\"line\">Starting program: /home/nolehuan/cpp/src/use_lib </span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 1, main () at use_lib.c:20</span><br><span class=\"line\">20\t  func();</span><br><span class=\"line\">(gdb) n</span><br><span class=\"line\"></span><br><span class=\"line\">Program received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\">0x0000000000000536 in ?? ()</span><br><span class=\"line\">(gdb) bt</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">0  0x0000000000000536 <span class=\"keyword\">in</span> ?? ()</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1  0x00007ffff75dc63a <span class=\"keyword\">in</span> func () at libtest.c:4</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2  0x000055555555487c <span class=\"keyword\">in</span> main () at use_lib.c:20</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>add 函数断点调试</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gdb use_lib</span></span><br><span class=\"line\">GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1</span><br><span class=\"line\">...</span><br><span class=\"line\">Reading symbols from use_lib...done.</span><br><span class=\"line\">(gdb) b 27</span><br><span class=\"line\">Breakpoint 1 at 0x8c7: file use_lib.c, line 27.</span><br><span class=\"line\">(gdb) r</span><br><span class=\"line\">Starting program: /home/nolehuan/cpp/src/use_lib </span><br><span class=\"line\">old lib</span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 1, main () at use_lib.c:27</span><br><span class=\"line\">27\t  add();</span><br><span class=\"line\">(gdb) n</span><br><span class=\"line\">29\t  dlclose(handle);</span><br></pre></td></tr></table></figure>\n<h4 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h4><ul>\n<li><code>cp</code> 更新动态库，文件 inode 号不变，旧库文件被截断，重新加载至内存时，或因为文件偏移量超出新库文件地址范围产生 bus error 导致程序 core 掉，或因为动态库依赖外部符号但全局符号表没有经过重新解析产生段错误导致程序 core 掉</li>\n<li><code>mv</code> 更新动态库，文件 inode 号改变，旧 inode 号依然存在，程序可以继续运行，必须重启服务才会加载新动态库</li>\n</ul>\n<h4 id=\"正确做法\"><a href=\"#正确做法\" class=\"headerlink\" title=\"正确做法\"></a>正确做法</h4><p><code>rm</code> + <code>cp</code> 或 <code>mv</code> + <code>cp</code></p>\n<p><code>rm</code> 时如果 ld.so 正在加载动态库，inode 不会立刻被删除，直至 ld.so 释放对动态库的引用，引用结束时才会真正删除 inode，程序不会崩溃，下次使用替换后的动态库</p>\n<p><code>mv</code> 仅改变文件名，inode 不变，新动态库使用新 inode，动态链接器 ld.so 使用原 inode 访问旧动态库</p>\n<p>替换可执行程序时，系统会明令禁止 <code>cp</code> 操作，但系统不会阻止覆盖动态库<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp xxx xxx</span><br><span class=\"line\">cp: cannot create regular file `xxx`: Text file busy</span><br></pre></td></tr></table></figure></p>\n<p>Demand Paging 机制</p>\n<p>程序运行时并非所有页都加载到内存中，只有需要访问时才会动态加载，Demand Paging 要求正在运行中的程序镜像不被意外修改，因此内核会锁定程序镜像的 inode</p>\n<p>对于动态库而言，依靠用户态程序 ld.so 加载，无权锁定 inode</p>\n<h4 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h4><p>环境变量</p>\n<ul>\n<li>LIBRARY_PATH 静态链接库文件搜索路径</li>\n<li>LD_LIBRARY_PATH 动态链接库文件搜索路径</li>\n</ul>\n<p>动态库 .so 与静态库 .a 同时存在时，<code>gcc/g++</code> 默认链接动态库，可使用参数 <code>-Wl,-Bstatic -lxxx</code> 或 <code>-Wl,-Bdynamic -lxxx</code> 指定链接静态/动态库</p>\n<p>参数 <code>-static</code> 指定完全静态加载</p>\n<p>静态库加载顺序</p>\n<ul>\n<li><code>gcc -L</code> 参数</li>\n<li>LIBRARY_PATH</li>\n<li>默认库目录</li>\n</ul>\n<p>动态库加载顺序</p>\n<ul>\n<li><code>gcc -L</code> 参数</li>\n<li>LD_LIBRARY_PATH</li>\n<li>/etc/ld.so.conf 配置文件中的路径</li>\n<li>默认库目录</li>\n</ul>\n<p><code>ldd</code> 查看可执行程序依赖的共享库</p>\n<p>动态库命名：<code>libxxxx.so.major.minor</code>，major 主版本号，minor 副版本号 </p>\n<p><code>gcc</code> 分阶段编译<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gcc -E libtest.c -o libtest.i</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gcc -S libtest.i -o libtest.s</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">gcc -c libtest.s -o libtest.o</span></span><br></pre></td></tr></table></figure></p>\n<p>生成静态库<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">ar cqs libtest.a libtest.o</span></span><br></pre></td></tr></table></figure></p>\n<p><code>ar</code> archive<br><code>c</code> 创建新的归档文件，已存在则覆盖<br><code>q</code> 快速追加<br><code>s</code> 构建对象索引文件，即符号表</p>\n<p><code>nm</code> 查看库中的函数</p>\n<ul>\n<li>T 函数在当前库中定义</li>\n<li>U 函数在其它库中定义被调用</li>\n<li>W 当前库中定义，被其它库中的函数覆盖</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nm libtest.so</span><br><span class=\"line\">000000000000063d T add</span><br><span class=\"line\">0000000000201028 B __bss_start</span><br><span class=\"line\">0000000000201028 b completed.7698</span><br><span class=\"line\">                 w __cxa_finalize@@GLIBC_2.2.5</span><br><span class=\"line\">0000000000000550 t deregister_tm_clones</span><br><span class=\"line\">00000000000005e0 t __do_global_dtors_aux</span><br><span class=\"line\">0000000000200e18 t __do_global_dtors_aux_fini_array_entry</span><br><span class=\"line\">0000000000201020 d __dso_handle</span><br><span class=\"line\">0000000000200e20 d _DYNAMIC</span><br><span class=\"line\">0000000000201028 D _edata</span><br><span class=\"line\">0000000000201030 B _end</span><br><span class=\"line\">0000000000000660 T _fini</span><br><span class=\"line\">0000000000000620 t frame_dummy</span><br><span class=\"line\">0000000000200e10 t __frame_dummy_init_array_entry</span><br><span class=\"line\">0000000000000738 r __FRAME_END__</span><br><span class=\"line\">000000000000062a T func</span><br><span class=\"line\">0000000000201000 d _GLOBAL_OFFSET_TABLE_</span><br><span class=\"line\">                 w __gmon_start__</span><br><span class=\"line\">0000000000000674 r __GNU_EH_FRAME_HDR</span><br><span class=\"line\">0000000000000500 T _init</span><br><span class=\"line\">                 w _ITM_deregisterTMCloneTable</span><br><span class=\"line\">                 w _ITM_registerTMCloneTable</span><br><span class=\"line\">                 U puts@@GLIBC_2.2.5</span><br><span class=\"line\">0000000000000590 t register_tm_clones</span><br><span class=\"line\">0000000000201028 d __TMC_END__</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">nm libtest.a</span> </span><br><span class=\"line\"></span><br><span class=\"line\">libtest.o:</span><br><span class=\"line\">0000000000000013 T add</span><br><span class=\"line\">0000000000000000 T func</span><br><span class=\"line\">                 U _GLOBAL_OFFSET_TABLE_</span><br><span class=\"line\">                 U puts</span><br></pre></td></tr></table></figure>\n<h4 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h4><p><a href=\"https://developer.aliyun.com/article/6371\">https://developer.aliyun.com/article/6371</a><br><a href=\"https://www.cnblogs.com/wangliangblog/p/10766986.html\">https://www.cnblogs.com/wangliangblog/p/10766986.html</a><br><a href=\"https://blog.csdn.net/BHJ1119/article/details/88219896\">https://blog.csdn.net/BHJ1119/article/details/88219896</a></p>\n","feature":false,"text":"使用 mv 与 cp 命令更新运行中的动态链接库是否会发生问题？...","permalink":"/post/linux/so","photos":[],"count_time":{"symbolsCount":"30k","symbolsTime":"28 mins."},"categories":[{"name":"coding","slug":"coding","count":4,"path":"api/categories/coding.json"}],"tags":[{"name":"cpp","slug":"cpp","count":5,"path":"api/tags/cpp.json"},{"name":"linux","slug":"linux","count":1,"path":"api/tags/linux.json"},{"name":"so","slug":"so","count":2,"path":"api/tags/so.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-mv-%E4%B8%8E-cp-%E5%91%BD%E4%BB%A4%E6%9B%B4%E6%96%B0%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E6%98%AF%E5%90%A6%E4%BC%9A%E5%8F%91%E7%94%9F%E9%97%AE%E9%A2%98%EF%BC%9F\"><span class=\"toc-text\">使用 mv 与 cp 命令更新运行中的动态链接库是否会发生问题？</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Linux-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F\"><span class=\"toc-text\">Linux 文件系统</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#inode\"><span class=\"toc-text\">inode</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#dentry\"><span class=\"toc-text\">dentry</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#cp-mv-rm-%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">cp mv rm 原理</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8A%A8%E6%80%81%E5%BA%93\"><span class=\"toc-text\">动态库</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">测试</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BB%93%E8%AE%BA\"><span class=\"toc-text\">结论</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%AD%A3%E7%A1%AE%E5%81%9A%E6%B3%95\"><span class=\"toc-text\">正确做法</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">相关内容</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83\"><span class=\"toc-text\">参考</span></a></li></ol></li></ol>","author":{"name":"NoleHuan","slug":"blog-author","avatar":"/img/tennis_logo.svg","link":"/","description":"The true nature of a heart is seen in its response to the unattractive.","socials":{"github":"https://github.com/nolehuan","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/5948495997","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"asm","uid":"764bdd9ac479a79e4d1149181d7f0f7f","slug":"linux/asm","date":"2023-11-27T21:30:29.000Z","updated":"2023-11-27T13:43:41.929Z","comments":true,"path":"api/articles/linux/asm.json","cover":null,"text":"lea, mov...","permalink":"/post/linux/asm","photos":[],"count_time":{"symbolsCount":231,"symbolsTime":"1 mins."},"categories":[{"name":"coding","slug":"coding","count":4,"path":"api/categories/coding.json"}],"tags":[{"name":"asm","slug":"asm","count":1,"path":"api/tags/asm.json"}],"author":{"name":"NoleHuan","slug":"blog-author","avatar":"/img/tennis_logo.svg","link":"/","description":"The true nature of a heart is seen in its response to the unattractive.","socials":{"github":"https://github.com/nolehuan","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/5948495997","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":false},"next_post":{"title":"daily","uid":"2b7dc717d2cad550b10ee602a360ec48","slug":"daily/index","date":"2023-11-18T15:30:29.000Z","updated":"2023-12-10T07:37:08.249Z","comments":true,"path":"api/articles/daily/index.json","cover":[],"text":"daily life...","permalink":"/post/daily/index","photos":[],"count_time":{"symbolsCount":352,"symbolsTime":"1 mins."},"categories":[{"name":"personal","slug":"personal","count":2,"path":"api/categories/personal.json"}],"tags":[{"name":"daily","slug":"daily","count":1,"path":"api/tags/daily.json"}],"author":{"name":"NoleHuan","slug":"blog-author","avatar":"/img/tennis_logo.svg","link":"/","description":"The true nature of a heart is seen in its response to the unattractive.","socials":{"github":"https://github.com/nolehuan","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/5948495997","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":false}}