{"title":"perf","uid":"a70851710c1098020b82511ef1e08d1a","slug":"linux/perf","date":"2023-12-09T13:11:29.000Z","updated":"2023-12-09T10:21:53.213Z","comments":true,"path":"api/articles/linux/perf.json","cover":[],"content":"<h3 id=\"线程状态\"><a href=\"#线程状态\" class=\"headerlink\" title=\"线程状态\"></a>线程状态</h3><div align=\"center\">\n  <img src=\"/img/thread_states.png\" style=\"width:50%;height:50%;\">\n</div>\n\n<ul>\n<li>On-CPU 线程在 CPU 上运行</li>\n<li>Off-CPU 线程由于等待 IO、锁、定时器、换页等原因阻塞</li>\n</ul>\n<h3 id=\"调度延迟\"><a href=\"#调度延迟\" class=\"headerlink\" title=\"调度延迟\"></a>调度延迟</h3><p>一个任务具备运行条件，进入 run queue，到真正执行的时间，包括</p>\n<ul>\n<li>调度器决策时间</li>\n<li>任务唤醒与实际运行之间的延迟，即上下文切换时间</li>\n</ul>\n<h3 id=\"perf\"><a href=\"#perf\" class=\"headerlink\" title=\"perf\"></a>perf</h3><h4 id=\"工具安装\"><a href=\"#工具安装\" class=\"headerlink\" title=\"工具安装\"></a>工具安装</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">sudo apt install linux-tools-common</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">sudo apt install linux-tools-`<span class=\"built_in\">uname</span> -a | awk <span class=\"string\">&#x27;&#123;print $3&#125;&#x27;</span>`</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">sudo apt install linux-cloud-tools-`<span class=\"built_in\">uname</span> -a | awk <span class=\"string\">&#x27;&#123;print $3&#125;&#x27;</span>`</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"工具使用\"><a href=\"#工具使用\" class=\"headerlink\" title=\"工具使用\"></a>工具使用</h4><p>示例程序<br><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat p.cc </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;atomic&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;thread&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Perf</span>;</span><br><span class=\"line\">std::atomic&lt;<span class=\"type\">bool</span>&gt; shutdown = &#123;<span class=\"literal\">false</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">sighandle</span><span class=\"params\">(<span class=\"type\">int</span> sig)</span> </span>&#123;</span><br><span class=\"line\">  (<span class=\"type\">void</span>)sig;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n shutdown \\n&quot;</span>);</span><br><span class=\"line\">  shutdown.<span class=\"built_in\">exchange</span>(<span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!shutdown) &#123;</span><br><span class=\"line\">    std::this_thread::<span class=\"built_in\">sleep_for</span>(std::chrono::<span class=\"built_in\">milliseconds</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">bar</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">foo</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Perf</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"built_in\">bar</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (!shutdown) &#123;</span><br><span class=\"line\">    Perf p;</span><br><span class=\"line\">    p.<span class=\"built_in\">f</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">signal</span>(SIGINT, sighandle);</span><br><span class=\"line\">  std::thread t = std::<span class=\"built_in\">thread</span>(func);</span><br><span class=\"line\">  t.<span class=\"built_in\">join</span>();</span><br><span class=\"line\">  <span class=\"built_in\">signal</span>(SIGINT, SIG_DFL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">sudo perf record -F 999 -p &lt;PID&gt; -g -- <span class=\"built_in\">sleep</span> 10</span></span><br><span class=\"line\">[ perf record: Woken up 1 times to write data ]</span><br><span class=\"line\">[ perf record: Captured and wrote 0.077 MB perf.data (403 samples) ]</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">sudo perf script -i perf.data &amp;&gt; perf.unfold</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">FlameGraph/stackcollapse-perf.pl perf.unfold &amp;&gt; perf.folded</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">git <span class=\"built_in\">clone</span> https://github.com/brendangregg/FlameGraph.git</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">FlameGraph/flamegraph.pl perf.folded &amp;&gt; flamegraph.svg</span></span><br></pre></td></tr></table></figure>\n<div align=\"center\">\n  <img src=\"/img/flamegraph.svg\" style=\"width:50%;height:50%;\">\n</div>\n<div align=\"center\">\n  <img src=\"/img/callstack.png\" style=\"width:50%;height:50%;\">\n</div>\n\n<p>火焰图</p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"https://www.brendangregg.com/offcpuanalysis.html\">https://www.brendangregg.com/offcpuanalysis.html</a><br><a href=\"https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html\">https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html</a><br><a href=\"https://github.com/brendangregg/FlameGraph\">https://github.com/brendangregg/FlameGraph</a></p>\n","feature":true,"text":"performance...","permalink":"/post/linux/perf","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"linux","slug":"linux","count":1,"path":"api/categories/linux.json"}],"tags":[{"name":"perf","slug":"perf","count":1,"path":"api/tags/perf.json"},{"name":"flamegraph","slug":"flamegraph","count":1,"path":"api/tags/flamegraph.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81\"><span class=\"toc-text\">线程状态</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B0%83%E5%BA%A6%E5%BB%B6%E8%BF%9F\"><span class=\"toc-text\">调度延迟</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#perf\"><span class=\"toc-text\">perf</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">工具安装</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">工具使用</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83\"><span class=\"toc-text\">参考</span></a></li></ol>","author":{"name":"NoleHuan","slug":"blog-author","avatar":"/img/tennis_logo.svg","link":"/","description":"The true nature of a heart is seen in its response to the unattractive.","socials":{"github":"https://github.com/nolehuan","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/5948495997","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"op","uid":"7790d923d44c9f611a31c98e9aa24f9f","slug":"linux/op","date":"2023-12-02T20:00:29.000Z","updated":"2023-12-09T07:25:46.545Z","comments":true,"path":"api/articles/linux/op.json","cover":null,"text":"optimise...","permalink":"/post/linux/op","photos":[],"count_time":{"symbolsCount":421,"symbolsTime":"1 mins."},"categories":[{"name":"coding","slug":"coding","count":4,"path":"api/categories/coding.json"}],"tags":[{"name":"cpp","slug":"cpp","count":3,"path":"api/tags/cpp.json"}],"author":{"name":"NoleHuan","slug":"blog-author","avatar":"/img/tennis_logo.svg","link":"/","description":"The true nature of a heart is seen in its response to the unattractive.","socials":{"github":"https://github.com/nolehuan","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/5948495997","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}